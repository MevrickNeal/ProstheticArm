<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Prosthetic: Digital Twin v1.5</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        /* CSS: Dashboard Styling */
        body {
            margin: 0; background-color: #0a0a0a; color: #00e676;
            font-family: 'Courier New', Courier, monospace; overflow: hidden;
            display: grid; grid-template-columns: 300px 1fr; height: 100vh;
        }

        #ui-panel {
            background: rgba(20, 20, 20, 0.9); border-right: 1px solid #333;
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            z-index: 10;
        }

        .status-box {
            padding: 10px; border: 1px solid #00e676; border-radius: 5px;
            font-size: 0.8rem; background: rgba(0, 230, 118, 0.1);
        }

        button {
            background: #00e676; color: black; border: none; padding: 12px;
            font-weight: bold; cursor: pointer; border-radius: 4px; transition: 0.3s;
        }

        button:hover { background: #fff; box-shadow: 0 0 15px #00e676; }

        #container3d { position: relative; width: 100%; height: 100%; }

        .telemetry { font-size: 0.7rem; color: #888; }
    </style>
</head>
<body>

    <div id="ui-panel">
        <h2 style="margin: 0;">PROSTHETIC OS</h2>
        <div class="status-box" id="serialStatus">STATUS: DISCONNECTED</div>
        
        <button id="connectBtn">CONNECT PORT 1420</button>
        
        <div class="telemetry">
            <h3>COMMAND LOG</h3>
            <div id="log" style="height: 100px; overflow-y: auto;">Waiting...</div>
        </div>

        <div class="telemetry">
            <h3>GESTURE MODE</h3>
            <select id="modeSelect" style="width: 100%; background: #222; color: #00e676; border: 1px solid #333;">
                <option value="vision">Vision (Digital Twin)</option>
                <option value="emg">EMG (Myoelectric)</option>
                <option value="hybrid">Hybrid Fusion</option>
            </select>
        </div>
        
        <button id="relaxBtn" style="background: #ff5252;">EMERGENCY RELAX</button>
    </div>

    <div id="container3d"></div>

    <script>
        /* JAVASCRIPT: Three.js & Web Serial Combined */
        
        let scene, camera, renderer, handMesh;
        let serialWriter = null;
        let lastCmd = "";

        // 1. Initialize 3D Scene
        function init3D() {
            const container = document.getElementById('container3d');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // Add Lighting
            const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
            scene.add(light);

            // Create a Proxy Hand Mesh (Boxy version for placeholder)
            const geometry = new THREE.BoxGeometry(1, 0.2, 1);
            const material = new THREE.MeshPhongMaterial({ color: 0x00e676, wireframe: true });
            handMesh = new THREE.Mesh(geometry, material);
            scene.add(handMesh);

            camera.position.z = 5;
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            // Simulated subtle movement for the "Digital Twin"
            handMesh.rotation.y += 0.005;
            renderer.render(scene, camera);
        }

        // 2. Web Serial Connection
        document.getElementById('connectBtn').onclick = async () => {
            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                const encoder = new TextEncoderStream();
                const outputStream = encoder.writable.pipeTo(port.writable);
                serialWriter = encoder.writable.getWriter();
                
                document.getElementById('serialStatus').innerText = "STATUS: CONNECTED (1420)";
                document.getElementById('serialStatus').style.background = "rgba(0, 230, 118, 0.3)";
                log("Serial Link Established.");
            } catch (e) {
                console.error(e);
                log("Connection Failed.");
            }
        };

        // 3. Command Dispatcher
        async function sendCommand(cmd) {
            if (!serialWriter || cmd === lastCmd) return;
            await serialWriter.write(cmd);
            lastCmd = cmd;
            log("Sent Command: " + cmd);
        }

        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = `> ${msg}<br>` + logDiv.innerHTML;
        }

        document.getElementById('relaxBtn').onclick = () => sendCommand('A');

        // Handle Window Resize
        window.onresize = () => {
            const container = document.getElementById('container3d');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        };

        init3D();
    </script>
</body>
</html>
